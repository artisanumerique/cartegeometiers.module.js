"use strict";angular.module("cartegeometiersmodulejsApp",["ngAnimate","ngResource","ngRoute","geometiersmodulejsApp","angularUtils.directives.dirPagination"]).constant("config",{API:"http://localhost/frameworkgeometiers/api",urlstyle:"cixlnex77000s2sntu1jcfn6o"}).config(["$routeProvider","$locationProvider","$provide",function(a,b,c){b.html5Mode(!0),c.decorator("$location",["$delegate","$injector","$rootScope","$timeout",function(a,b,c,d){function e(e,h){if(f=b.get("$route"),0==arguments[1])var i=f.current,j=c.$on("$locationChangeSuccess",function(){f.current=i,j()});return d(g.apply(a,arguments),0)}var f,g=a.url;return a.url=e,a}]),a.when("/:nomterritoire/lat/:lat/lon/:lon/?",{templateUrl:"views/cartegeometiers.template.html"}).otherwise({redirectTo:"/"})}]).run(["$route","$rootScope","$location","$timeout",function(a,b,c,d){b.$on("$viewContentLoaded",function(a){d(function(){componentHandler.upgradeAllRegistered()},0)})}]),angular.module("cartegeometiersmodulejsApp").controller("CartegeometiersCtrl",["$scope","$location","$routeParams","$timeout","FiltreBounds","Filtre","Webservice","tools","$window","config","Artisans",function(a,b,c,d,e,f,g,h,i,j,k){e.init(c),a.map={center:{lat:e.lat,lng:e.lon},zoom:e.zoom},a.items=[],a.totalItems=0,a.loading=!1,a.itemsPerPage=25,a.currentPage=e.page,a.urlstyle=j.urlstyle;var l=function(c){a.loading=!0,g.get(e.getParams(c),function(c){a.loading=!1,a.refresh=!0,a.items=c.features,a.totalItems=a.items.length,e.page=a.currentPage,b.url(e.url(),!1)})};a.getItemsWhenUrlChange=function(a){l(a)},a.getItemsWhenMapMove=function(b){a.currentPage=1,l(b)},a.pageChange=function(c){e.page=a.currentPage,b.url(e.url(),!1),a.refresh=!0},a.setSiret=function(b){a.$broadcast("newsiret",b)},a.$on("update.location",function(){a.loading=!0,angular.isDefined(f.getByName("siret"))&&f.removeAllFiltres();var b=f.params();b.push({name:"action",value:"filtrer"}),g.get(h.arrayToObject(b),function(b){a.loading=!1,b.features.length>0&&e.setCenter(b.features[0].properties.centre),e.insideCommune=!0,e.zoom=15,e.lieu=b.statistique.titre[0],e.page=1,a.currentPage=1,a.map={center:{lat:e.lat,lng:e.lon},zoom:e.zoom}})}),a.$on("update.filtres",function(){e.zoom=15,angular.isDefined(f.getByName("siret"))?k.fiche.get({id:f.getByName("siret")},function(a){e.setCenter({type:"Point",coordinates:[a._longitude,a._latitude]}),e.lieu=a._commune,e.page=1,i.open(e.url(),"_self")}):(angular.isDefined(f.getByName("siret"))&&f.removeFiltre("siret"),a.getItemsWhenUrlChange(!1))})}]),angular.module("cartegeometiersmodulejsApp").factory("Icone",function(){var a=L.Icon.extend({options:{shadowUrl:"images/pins/shadow.291a11cc.png",number:"",iconSize:[42,60],shadowSize:[42,12],shadowAnchor:[21,-18],popupAnchor:[0,-18],className:"cma-div-icon"},createIcon:function(){var a=document.createElement("div"),b=this._createImg(this.options.iconUrl),c=document.createElement("div");return c.setAttribute("class","number"),c.innerHTML=this.options.number||"",a.appendChild(b),a.appendChild(c),this._setIconStyles(a,"icon"),a}}),b=new a({iconUrl:"images/pins/ico.ca11495c.png"}),c=new a({iconUrl:"images/pins/icoblue.e785aaab.png"}),d=new a({iconUrl:"images/pins/icored.0be557e2.png"}),e={groupeartisan:function(){return L.featureGroup()},pointToLayer:function(a,e,f){return"MAITRE ARTISAN"==a.properties.titrequalif||"Maître artisan en métiers d'art"==a.properties.titrequalif?L.marker(e,{icon:d,riseOnHover:!0}):"ARTISAN"==a.properties.titrequalif||"Artisan en métiers d'art"==a.properties.titrequalif?L.marker(e,{icon:c,riseOnHover:!0}):L.marker(e,{icon:b,riseOnHover:!0})},artisanMarkerIcon:function(a){return"MAITRE ARTISAN"==a||"Maître artisan en métiers d'art"==a?d:"ARTISAN"==a||"Artisan en métiers d'art"==a?c:b}};return e}),angular.module("cartegeometiersmodulejsApp").factory("Artisans",["$resource","config",function(a,b){return{fiche:a(b.API+"/artisans/:id",{},{get:{method:"GET",cache:!0}}),photos:a(b.API+"/artisans/:id/photos",{},{get:{method:"GET",cache:!0}}),videos:a(b.API+"/artisans/:id/videos",{},{get:{method:"GET",cache:!0,isArray:!0}})}}]),angular.module("cartegeometiersmodulejsApp").directive("drawMap",["$rootScope","$animate","$location","$timeout","FiltreBounds","Icone","limitToFilter",function(a,b,c,d,e,f,g){return{restrict:"EA",replace:!0,templateUrl:"views/drawmap.template.html",scope:!0,link:function(c,d,h){b.enabled(!1,d);var i=L.map(h.id,{scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!0,minZoom:13,maxZoom:18,attributionControl:!1,center:[c.map.center.lat,c.map.center.lng],zoom:c.map.zoom}).setView([c.map.center.lat,c.map.center.lng],c.map.zoom);L.tileLayer("https://api.mapbox.com/styles/v1/art82/"+c.urlstyle+"/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYXJ0ODIiLCJhIjoic3hwSDFJRSJ9.D82gjhYrYR935Knj8cNVwg",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>'}).addTo(i),c.markers=f.groupeartisan(),i.addLayer(c.markers),e.setBounds(angular.toJson(i.getBounds())),c.getItemsWhenUrlChange(!0),i.on({moveend:function(){e.setBounds(angular.toJson(i.getBounds())),c.pinsonmove?c.getItemsWhenMapMove(!1):(c.rechercheActive=!1,c.$apply())},zoomend:function(a){c.map.zoom=a.target._zoom,e.zoom=c.map.zoom}}),c.$watch("map",function(){i.setView([c.map.center.lat,c.map.center.lng],c.map.zoom)}),c.$watch("items",function(){j()}),c.$watch("currentPage",function(){j()}),c.$on("newsiret",function(a,b){c.markers.eachLayer(function(a){""!=b?a.feature.properties.numerosiret==b&&a.fireEvent("mouseover"):a.fireEvent("mouseout")})}),c.move=function(){c.rechercheActive=!0,e.setBounds(angular.toJson(i.getBounds())),c.getItemsWhenMapMove(!1)};var j=function(){var b=g(c.items,c.itemsPerPage,c.itemsPerPage*(c.currentPage-1));c.markers.clearLayers();var d=L.geoJson(b,{pointToLayer:function(a,b){return f.pointToLayer(a,b)},onEachFeature:function(b,c){c.on({click:function(b){a.$broadcast("selectpins",c)},mouseover:function(a){c.setZIndexOffset(1e3),c.openPopup()},mouseout:function(a){c.setZIndexOffset(100),c.closePopup()}});var d=L.popup({autoPan:!1,closeButton:!1,className:"pinspopup"}).setContent("<h4>"+b.properties.raisonsociale+"</h4>");c.bindPopup(d)}}),e=0;d.eachLayer(function(a){e++,a.options.icon.options.number=e,c.markers.addLayer(a)})}}}}]),angular.module("cartegeometiersmodulejsApp").directive("scrollIf",function(){return{restrict:"EA",scope:{change:"="},link:function(a,b,c){a.$watch("change",function(c){b.animate({scrollTop:0},"fast"),a.change=!1})}}}),angular.module("cartegeometiersmodulejsApp").directive("artisanThumbnail",["Artisans",function(a){return{template:'<span><i class="material-icons mdl-list__item-avatar" ng-show="!thumbnail">person</i><img class="material-icons mdl-list__item-avatar" src="{{thumbnail}}" ng-show="thumbnail"/></span>',restrict:"E",replace:!0,link:function(a,b,c){var d=a.artisan;""!=d.properties.fiche._profil_img&&(a.thumbnail=d.properties.fiche._profil_img)}}}]),angular.module("cartegeometiersmodulejsApp").directive("artisanThumbnaildetail",["Artisans",function(a){return{template:'<span class="profilimg"><i class=\'material-icons\' ng-show=\'!thumbnail\'>&#xE7FD;</i><div style="background: url({{thumbnail}}) center / cover #eee;" ng-show="thumbnail"></div></span>',restrict:"EA",replace:!0,link:function(b,c,d){b.$watch("artisan",function(){angular.isDefined(b.artisan)&&a.photos.get({id:b.artisan._numerosiret},function(a){a.profil.length>0&&(b.thumbnail=a.profil.large)})})}}}]),angular.module("cartegeometiersmodulejsApp").directive("mdlUpgrade",["$timeout",function(a){return{restrict:"A",compile:function(){return{post:function(b,c){a(function(){componentHandler.upgradeElements(c[0])},0)}}}}}]),angular.module("cartegeometiersmodulejsApp").directive("drawList",function(){return{restrict:"EA",replace:!0,templateUrl:function(a,b){return b.templateUrl?b.templateUrl:"views/drawlist.template.html"},link:function(a,b,c){var d=["MAITRE ARTISAN","ARTISAN","Artisan en métiers d'art","Maître artisan en métiers d'art"];a.showLogo=function(a){return-1!=d.indexOf(a)}}}}),angular.module("cartegeometiersmodulejsApp").directive("carteGeometiers",function(){return{templateUrl:function(a,b){return b.templateUrl?b.templateUrl:"views/cartegeometiers.template.html"},restrict:"EA",replace:!0}}),angular.module("cartegeometiersmodulejsApp").run(["$templateCache",function(a){a.put("views/cartegeometiers.template.html",'<!--<input search-location parent="{name: \'pays\', value: \'3\'}" type="commune,artisan" ng-click="filtre = \'\'" placeholder="Trouver une commune ou un artisan" ng-model="filtre" type="text" class="sig-search-field" >\r\n--> <main class="sig-main mdl-layout__content" ng-controller="CartegeometiersCtrl"> <div class="resultat-list"> <div id="opaque-modal" ng-class="{\'visible\':loading}"></div> <draw-list></draw-list> </div> <div class="resultat-carte"> <draw-map id="map-pins"></draw-map> </div> </main>'),a.put("views/dirPagination.tpl.html",'<div class="resultat-error" ng-show="range.total == 0"> <p><b>Désolés ! Aucun résultat ne correspond à votre recherche</b></p> <p>Essayez de : <ul> <li>Faire un zoom arrière sur la carte pour effectuer une recherche sur une zone plus importante</li> <li>Faire une recherche plus large sur les métiers, comme les secteurs par exemples (Alimentation, Services, Bâtiments, Fabrication)</li> <li>Désélectionner des filtres</li> </ul> </p> </div> <div ng-if="1 < pages.length || !autoHide" class="range-label">{{ range.lower }} / {{ range.upper }} sur {{ range.total }} artisan(s)</div> <div class="page" ng-if="1 < pages.length || !autoHide"> <button class="mdl-button mdl-js-button" title="Page précédente" ng-class="{ disabled : pagination.current == 1 }" ng-click="setCurrent(pagination.current - 1)"> <i class="material-icons">&#xE314;</i> </button> <button class="mdl-button mdl-js-button" title="Page suivante" ng-class="{ disabled : pagination.current == pagination.last }" ng-click="setCurrent(pagination.current + 1)"> <i class="material-icons">&#xE315;</i> </button> </div>'),a.put("views/drawlist.template.html",'<div scroll-if change="refresh" class="mdl-layout__content"> <ul class="mdl-list"> <li class="mdl-list__item mdl-list__item--three-line" dir-paginate="artisan in items | itemsPerPage: itemsPerPage" current-page="currentPage" id="{{artisan.properties.numerosiret}}" ng-mouseover="setSiret(artisan.properties.numerosiret)" ng-mouseleave="setSiret(\'\')" ng-click="select(artisan)"> <span class="mdl-list__item-primary-content"> <artisan-thumbnail></artisan-thumbnail> <span> <!--<span class="number">{{$index + 1}}.</span>--> {{ artisan.properties.raisonsociale | limitTo: 25 }}{{artisan.properties.raisonsociale.length > 25 ? \'...\' : \'\'}}</span> <span class="mdl-list__item-text-body">{{ artisan.properties.libelleaprm | limitTo: 75 }}{{artisan.properties.libelleaprm.length > 75 ? \'...\' : \'\'}}</span> </span> <span class="mdl-list__item-secondary-content" ng-show="showLogo(artisan.properties.titrequalif)"> <a class="mdl-list__item-secondary-action" href="#"><img src="images/logo-artisan-list.06cc24ed.png"></a> </span> </li> </ul> <dir-pagination-controls class="pagination-control" on-page-change="pageChange()" template-url="views/dirPagination.tpl.html"></dir-pagination-controls> </div>'),a.put("views/drawmap.template.html",'<div id="map-pins"> <div id="rechercher" ng-init="rechercheActive=true"> <div ng-show="rechercheActive" class="dep"> <label class="mdl-checkbox mdl-js-checkbox" for="checkbox-1" mdl-upgrade> <input type="checkbox" id="checkbox-1" class="mdl-checkbox__input" checked ng-init="pinsonmove = true" ng-click="pinsonmove = !pinsonmove"> <span class="mdl-checkbox__label">Rechercher en déplaçant la carte</span> </label> </div> <div ng-hide="rechercheActive" class="refresh"> <a ng-click="move()">Relancer la recherche</a> <i class="material-icons">&#xE5D5;</i> </div> </div> </div>')}]);